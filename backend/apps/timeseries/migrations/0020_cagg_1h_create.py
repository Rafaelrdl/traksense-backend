# Generated by Copilot - 2024
from django.db import migrations


class Migration(migrations.Migration):
    """
    Continuous Aggregate 1h - CREATE VIEW
    """

    dependencies = [
        ('timeseries', '0019_cagg_5m_materialize'),
    ]

    operations = [
        migrations.RunSQL(
            sql="""
            DROP VIEW IF EXISTS public.ts_measure_1h CASCADE;
            DROP MATERIALIZED VIEW IF EXISTS public.ts_measure_1h CASCADE;
            
            CREATE MATERIALIZED VIEW public.ts_measure_1h
            WITH (timescaledb.continuous) AS
            SELECT 
                time_bucket('1 hour', ts) AS bucket,
                tenant_id,
                device_id,
                point_id,
                AVG(v_num) AS v_avg,
                MAX(v_num) AS v_max,
                MIN(v_num) AS v_min,
                COUNT(v_num) AS n
            FROM public.ts_measure
            WHERE v_num IS NOT NULL
            GROUP BY bucket, tenant_id, device_id, point_id
            WITH NO DATA;
            """,
            reverse_sql="""
            DROP MATERIALIZED VIEW IF EXISTS public.ts_measure_1h CASCADE;
            """
        ),
    ]
